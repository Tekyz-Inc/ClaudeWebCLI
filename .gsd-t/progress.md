# GSD-T Progress

## Project: ClaudeWebCLI
## Version: 0.6.0
## Current Milestone
None — ready for next milestone

## Completed Milestones
| # | Milestone | Version | Completed | Tag |
|---|-----------|---------|-----------|-----|
| 4 | Real-Time Whisper Correction | 0.5.0 | 2026-02-13 | v0.5.0 |
| 3 | Browser-Side Whisper Voice | 0.4.0 | 2026-02-13 | v0.4.0 |
| 2 | Smart Voice Dictation | 0.3.0 | 2026-02-12 | v0.3.0 |
| 1 | Foundation — Daily Workflow + Voice + Files | 0.2.0 | 2026-02-11 | v0.2.0 |

## Upcoming
| # | Milestone | Priority | Source |
|---|-----------|----------|--------|
| 2.1 | Fix Windows Path Test Failures | MEDIUM | TD-011 |

## Decision Log
- 2026-02-10: Project initialized with GSD-T workflow
- 2026-02-10: Deep codebase scan completed (first scan). Forked from The Vibe Companion v0.14.1. Findings: 7 critical security issues, 4 critical tech debt items, 23 total debt items. 517/522 tests pass (5 Windows path failures). Typecheck clean. Living docs created (architecture, workflows, infrastructure, requirements). Tech debt register at .gsd-t/techdebt.md with 4 suggested milestones.
- 2026-02-10: Milestone 1 "Foundation" defined. Scope adjusted from 10 features to actual new work needed against v0.14.1 fork.
- 2026-02-11: Milestone 1 partitioned, planned, executed (7 tasks, 3 domains), integrated, verified. Version 0.1.0 → 0.2.0.
- 2026-02-11: [quick] Unified HomePage/Composer interfaces, fixed voice streaming duplication, added subscription usage tracking.
- 2026-02-12: Promoted TD-011 (Windows Path Compatibility) to Milestone 2.1.
- 2026-02-12: Milestone 2 "Smart Voice Dictation" — replaced regex punctuation with AI-powered contextual formatting via one-shot Claude CLI. 3 domains, 8 tasks, all verified. 28/28 acceptance criteria PASS. Version 0.2.0 → 0.3.0.
- 2026-02-12: [debug] Fixed 3 voice dictation bugs: (1) Switched model from Sonnet to Haiku for faster formatting, embedded instructions in prompt instead of --system-prompt flag, fixed `which`→`where` on Windows. (2) Increased timeout 5s→15s. (3) Fixed text duplication on keypress by blocking textarea onChange during active voice/formatter state.
- 2026-02-12: [debug] Fixed voice formatting failures: Windows binary resolution prefers .exe, CLI runs from tmpdir to avoid 37K-token project context, removed auto-debounce (format on flush only), increased timeout to 30s, added content-based dedup in SpeechRecognition.
- 2026-02-12: [quick] Moved reconnection/disconnection banners from ChatView (row insertion) to TopBar inline status to prevent disorienting layout shifts.
- 2026-02-12: Milestone 3 "Browser-Side Whisper Voice" defined. Replace Web Speech API + Claude CLI formatting with in-browser Whisper (whisper-small, quantized ~530MB) via @huggingface/transformers + WebGPU. Single-step transcription with built-in punctuation/capitalization. Fallback to Web Speech API for non-WebGPU browsers.
- 2026-02-13: Milestone 3 completed. 3 domains, 9 tasks, all verified. Whisper engine (Web Worker + audio capture), unified voice hook (Whisper primary + Web Speech fallback), UI cleanup (Composer/HomePage integration, 4 legacy files deleted, server route removed). Version 0.3.0 → 0.4.0.
- 2026-02-13: [debug] Fixed Whisper voice pipeline: (1) MediaRecorder encode/decode roundtrip corrupted audio causing "you" hallucinations — replaced with raw PCM capture via ScriptProcessorNode, proper resampling via OfflineAudioContext. (2) Race condition where model loading between start/stop caused backend mismatch — added activeBackendRef. (3) No streaming text — now runs Web Speech API simultaneously with Whisper capture for live preview, Whisper result replaces preview on stop.
- 2026-02-13: [debug] Fixed Speech API streaming preview not showing text during Whisper recording: (1) setInterimText("") cleared accumulated text on each final result — now shows full accumulated text. (2) onerror killed recognitionRef in whisper mode — now non-fatal. (3) onend cleared preview and stopped — now auto-restarts Speech API to keep streaming.
- 2026-02-13: [debug] Fixed Whisper not correcting text on stop: start() only used Whisper path when model was already loaded. On first mic click after page load, speech-only mode had no raw capture → no Whisper correction. Now always uses whisper path (raw capture + Speech API preview) when Whisper is supported. On stop, corrects with Whisper if model loaded, otherwise falls back to Speech API text. Also fixed orphaned SpeechRecognition restart by clearing recognitionRef before .stop().
- 2026-02-13: [debug] Fixed useEffect cleanup killing recording on every re-render: useEffect depended on [whisper] but whisper is a new object each render. Cleanup ran on EVERY re-render, aborting SpeechRecognition and cancelling raw capture mid-recording. Fix: whisperRef + empty deps for unmount-only cleanup. Also added stale instance guards (recognitionRef.current !== recognition) on all SpeechRecognition handlers to prevent race conditions between old callbacks and new sessions.
- 2026-02-13: Milestone 4 partitioned into 2 domains: whisper-engine (snapshotAudio, worker cancellation, transcribeSnapshot), correction-orchestration (pause detection, 5s/10s timers, text replacement). Contracts updated. Old M3 domains cleaned up.
- 2026-02-13: Milestone 4 executed and verified. 6/6 tasks complete across 2 domains. audio-utils.ts: snapshotAudio + resampleAudio (extracted from stopRawCapture). whisper-worker.ts: cancel message with ID-based discard. use-whisper.ts: transcribeSnapshot + cancelTranscription. use-voice-input.ts: correction triggers via correctionFnRef pattern (pause >= 5s, forced 10s timer). 16 tests pass (5 new correction tests). 563/568 total tests pass (5 pre-existing TD-011). Typecheck clean.
- 2026-02-13: [quick] Voice UX improvements: mixed-style overlay (only uncorrected text italic), cursor-position voice insertion, flash-clear fix on stop, Whisper hallucination filter, Send auto-stops mic with final Whisper transcription, canSend checks displayText.
- 2026-02-16: [debug] Fix correction failing on longer recordings: whisper-tiny truncated audio >30s — added chunk_length_s/stride_length_s for long-form transcription. Reduced correction timing: pause threshold 5s→3s, forced interval 10s→5s.
- 2026-02-16: Initialized backlog files (backlog.md, backlog-settings.md). Auto-derived settings: types (bug/feature/improvement/ux/architecture/debt), app (claudewebcli), categories (voice/ui/server/websocket/infrastructure/testing).
- 2026-02-16 13:55: Added 4 backlog items: BL-001 Code Compare View, BL-002 Split View Terminal, BL-003 Web Viewer/App Preview, BL-004 Web Viewer Context Awareness. All categorized as feature/ui. BL-004 depends on BL-003.
- 2026-02-16 15:40: [quick] Added STT-component toggle mode. `bun run dev --component` starts on ports 3457/5175 using @tekyz/stt-component via Vite resolve.alias swap of use-voice-input.js. Default `bun run dev` unchanged. Files: package.json (+link dep), dev.ts (--component flag), vite.config.ts (alias/port), use-voice-input-component.ts (new hook wrapping STTEngine).
- 2026-02-16 16:40: [debug] Fixed 3 component-mode issues: (1) Vite alias regex partial match — changed `/\/use-voice-input\.js$/` to `/^.*\/use-voice-input\.js$/` for full specifier replacement. (2) Worker URL resolution — npm package bundles worker into index.js but Web Workers need separate files. Created local stt-component-worker.ts entry point, passed URL to STTEngine. (3) No streaming text + duplicate on stop — added Speech API streaming preview (same pattern as original hook), cleared interimText/correctedText on stop to prevent displayText doubling, added isActiveRef guard to ignore correction events after stop. 15 new tests, 579/584 pass (5 pre-existing TD-011).
- 2026-02-16 17:10: [debug] Fixed 2 voice input bugs: (1) Display flash-clear on stop — hooks cleared interimText/isProcessing before consumer inserted text into `text` state, causing one render with empty display. Fix: hooks keep voice state populated in stop(), expose clearState() method, consumer calls clearState() after setText() so React batches both updates into one render. voiceActive condition simplified to `!!voice.interimText`. (2) Spacebar duplicates text while recording — HomePage.tsx handleInput had no isListening guard (Composer had one). User typing during recording wrote displayText (text+interimText) back to text state, doubling voice content. Fix: added `voice.isListening || voice.isProcessing` guard to both components. Files: use-voice-input.ts, use-voice-input-component.ts, Composer.tsx, HomePage.tsx. 15/15 component tests pass, 44/44 E2E tests pass.
- 2026-02-16 17:55: [debug] Fixed component-mode mid-recording text duplication. Root cause: Speech API finals appended to accumulatedRef after Whisper correction replaced it — both transcribe same audio, so appended finals duplicated corrected content. Initial fix (restart Speech API on each correction) fixed duplication but killed streaming — Speech API was restarted every 3-5s, never producing enough results. Final fix: skipFinalsRef flag. After each correction, skip Speech API finals (they'd overlap with corrected text), but KEEP interims flowing for streaming preview. Flag clears when Speech API naturally restarts (onend → start). No more duplication, streaming works. Component hook only — original not affected.
- 2026-02-16 17:10: Added Playwright E2E test infrastructure. Installed @playwright/test + Chromium. Created playwright.config.ts with dual-project setup (original on :5174, component on :5175). Wrote 22 comprehensive E2E tests in tests/e2e/app.spec.ts covering page load, sidebar, textarea, voice input, dark mode, edge cases (rapid clicks, console errors, unhandled rejections, long input, paste), and responsive layout. Added 4 npm scripts (test:e2e, test:e2e:original, test:e2e:component, test:e2e:headed). All 44 tests pass (22 × 2 projects).
- 2026-02-17 07:10: [checkin] Version 0.5.0 → 0.6.0. STT-component mode, voice bug fixes (display flash, spacebar duplication, component streaming), Windows `which`→`where` fix, Playwright E2E tests, backlog init. Updated .gitignore, CHANGELOG.md, Sidebar version label.
